# .github/workflows/ci-cd.yml

name: CI-CD for Azure Deployment

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    name: "Build and Test Pipeline"
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Setup DVC
      uses: iterative/setup-dvc@v1

    - name: Install DVC Azure extras
      run: python -m pip install --upgrade pip && pip install "dvc[azure]"

    - name: Configure DVC remote and pull data
      env:
        AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
      run: |
        # Write the connection string into local config so DVC can authenticate
        dvc remote modify --local myremote connection_string "$AZURE_STORAGE_CONNECTION_STRING" || true
        # Pull required files from the configured Azure remote
        dvc pull --verbose
    
    - name: Reproduce DVC pipeline
      run: |
        dvc repro
        
    - name: Upload metrics
      uses: actions/upload-artifact@v4
      with:
        name: metrics
        path: |
          metrics/metrics.json
          metrics/metrics.txt

  build-and-deploy:
    name: "Build and Deploy to AKS"
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install DVC (Azure support)
      run: python -m pip install --upgrade pip && pip install "dvc[azure]"

    - name: Pull DVC data (models) for image build
      env:
        AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
      run: |
        dvc remote modify --local myremote connection_string "$AZURE_STORAGE_CONNECTION_STRING" || true
        dvc pull --verbose

    # --- ADD THESE STEPS ---
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install DVC
      run: |
        pip install dvc dvc-azure
        
    - name: Setup DVC
      uses: iterative/setup-dvc@v1

    - name: Configure DVC Remote
      env:
        AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
      run: |
        dvc remote modify --local myremote connection_string "$AZURE_STORAGE_CONNECTION_STRING"

    - name: Pull DVC Data and Models
      env:
        AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
      run: |
        dvc pull
        # We don't need dvc repro, just pull the final models
    
    # --- END OF ADDED STEPS ---

    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Log in to Azure Container Registry (ACR)
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_NAME }}.azurecr.io
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}
    
    - name: Build and push Docker image
      run: |
        docker build -t foodwasteacr.azurecr.io/food-waste-predictor:${{ github.sha }} .
        docker push foodwasteacr.azurecr.io/food-waste-predictor:${{ github.sha }}

    - name: Set up Kubeconfig for AKS
      uses: azure/aks-set-context@v3
      with:
        resource-group: ${{ secrets.AZURE_RG }}
        cluster-name: ${{ secrets.AKS_CLUSTER_NAME }}

    - name: Deploy to AKS
      uses: Azure/k8s-deploy@v4
      with:
        manifests: |
          k8s/deployment.yaml
          k8s/service.yaml
        images: |
          foodwasteacr.azurecr.io/food-waste-predictor:${{ github.sha }}
