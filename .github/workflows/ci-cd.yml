# .github/workflows/ci-cd.yml

name: CI-CD for Azure Deployment

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    name: "Build and Test Pipeline"
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Setup DVC
      uses: iterative/setup-dvc@v1
    
    # --- DVC PULL STEP ---
    # You must configure DVC remote storage (e.g., Azure Blob)
    # and add credentials as GitHub Secrets (AZURE_STORAGE_CONNECTION_STRING)
    #
    # - name: Pull DVC Data
    #   env:
    #     AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
    #   run: |
    #     dvc remote modify myremote connection_string $AZURE_STORAGE_CONNECTION_STRING
    #     dvc pull -r myremote
    
    - name: Reproduce DVC pipeline
      run: |
        dvc repro
        
    - name: Upload metrics
      uses: actions/upload-artifact@v3
      with:
        name: metrics
        path: |
          metrics/metrics.json
          metrics/metrics.txt

  build-and-deploy:
    name: "Build and Deploy to AKS"
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' # Only deploy from main branch

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }} # Store as JSON in GitHub Secrets

    - name: Log in to Azure Container Registry (ACR)
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_NAME }}.azurecr.io
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}
    
    - name: Build and push Docker image
      run: |
        docker build -t ${{ secrets.ACR_NAME }}.azurecr.io/food-waste-predictor:${{ github.sha }} .
        docker push ${{ secrets.ACR_NAME }}.azurecr.io/food-waste-predictor:${{ github.sha }}

    - name: Set up Kubeconfig for AKS
      uses: azure/aks-set-context@v3
      with:
        resource-group: ${{ secrets.AZURE_RG }}
        cluster-name: ${{ secrets.AKS_CLUSTER_NAME }}

    - name: Deploy to AKS
      uses: Azure/k8s-deploy@v4
      with:
        manifests: |
          k8s/deployment.yaml
          k8s/service.yaml
        images: |
          ${{ secrets.ACR_NAME }}.azurecr.io/food-waste-predictor:${{ github.sha }}
        # This command substitutes the image tag in deployment.yaml
        substitutions: |
          imageTag=${{ github.sha }}